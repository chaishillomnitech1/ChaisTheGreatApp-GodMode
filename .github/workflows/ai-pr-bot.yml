name: AI PR Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  ai-pr-analysis:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != 'dependabot[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Get PR diff
        id: pr-diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD)
          # Truncate diff to avoid API limits (keep first 6000 chars for conservative usage)
          DIFF_TRUNCATED="${DIFF:0:6000}"
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Analyze PR with OpenAI
        id: ai-analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "âš ï¸ OPENAI_API_KEY not configured, skipping AI analysis"
            echo "summary=AI analysis unavailable - OPENAI_API_KEY not configured" >> $GITHUB_OUTPUT
            echo "labels=enhancement" >> $GITHUB_OUTPUT
            echo "changelog=- Updated repository" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_DIFF="${{ steps.pr-diff.outputs.diff }}"
          
          # Create request payload with conservative settings
          cat > request.json <<EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are a code review assistant. Analyze pull requests and provide: 1) a brief summary (max 100 words), 2) suggested labels from: bug, enhancement, documentation, security, dependencies, ci-cd, breaking-change, and 3) a one-line changelog entry. Output as JSON with keys: summary, labels (array), changelog."
              },
              {
                "role": "user",
                "content": "PR Title: $PR_TITLE\n\nDescription: $PR_BODY\n\nDiff preview:\n$PR_DIFF"
              }
            ],
            "temperature": 0.3,
            "max_tokens": 300
          }
          EOF
          
          # Call OpenAI API
          RESPONSE=$(curl -s --max-time 30 https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json)
          
          # Extract and parse response
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$CONTENT" ]; then
            echo "âš ï¸ AI analysis failed or returned empty"
            echo "summary=AI analysis unavailable" >> $GITHUB_OUTPUT
            echo "labels=enhancement" >> $GITHUB_OUTPUT
            echo "changelog=- Updated repository" >> $GITHUB_OUTPUT
          else
            SUMMARY=$(echo "$CONTENT" | jq -r '.summary // "AI-generated summary unavailable"')
            LABELS=$(echo "$CONTENT" | jq -r '.labels[]? // "enhancement"' | tr '\n' ',' | sed 's/,$//')
            CHANGELOG=$(echo "$CONTENT" | jq -r '.changelog // "- Updated repository"')
            
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
            echo "labels=$LABELS" >> $GITHUB_OUTPUT
            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          fi
      
      - name: Post AI Analysis Comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.ai-analysis.outputs.summary }}`;
            const labels = `${{ steps.ai-analysis.outputs.labels }}`.split(',').filter(l => l);
            const changelog = `${{ steps.ai-analysis.outputs.changelog }}`;
            
            const comment = `## ðŸ¤– AI PR Bot Analysis
            
            ### Summary
            ${summary}
            
            ### Suggested Labels
            ${labels.map(l => \`\\\`${l}\\\`\`).join(', ')}
            
            ### Changelog Entry
            \\\`\\\`\\\`
            ${changelog}
            \\\`\\\`\\\`
            
            ---
            *ðŸ”’ Conservative mode: No auto-merge, manual review required*
            *Generated by AI PR Bot using GPT-3.5 (temperature: 0.3)*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Log Analysis Results
        run: |
          echo "âœ… AI PR Bot completed successfully"
          echo "Summary: ${{ steps.ai-analysis.outputs.summary }}"
          echo "Labels: ${{ steps.ai-analysis.outputs.labels }}"
          echo "Changelog: ${{ steps.ai-analysis.outputs.changelog }}"
          echo ""
          echo "ðŸ”’ Security Note: No secrets exposed, no auto-merge performed"
