name: AI-Powered PR Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  pr-assistant:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: pr-diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD)
          # Truncate diff to avoid API limits (keep first 8000 chars)
          DIFF_TRUNCATED="${DIFF:0:8000}"
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate PR Summary with OpenAI
        id: openai-summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_DIFF: ${{ steps.pr-diff.outputs.diff }}
        run: |
          # Create request payload
          cat > request.json <<EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are a helpful assistant that analyzes pull requests and provides concise summaries, suggests appropriate labels, and generates changelog entries. Format your response as JSON with keys: summary, labels (array of strings), changelog."
              },
              {
                "role": "user",
                "content": "Analyze this PR:\n\nTitle: $PR_TITLE\n\nDescription: $PR_BODY\n\nDiff:\n$PR_DIFF\n\nProvide a summary, suggested labels (choose from: bug, enhancement, documentation, security, dependencies, ci-cd, breaking-change), and a changelog entry."
              }
            ],
            "temperature": 0.7,
            "max_tokens": 500
          }
          EOF

          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json)

          # Extract content from response
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$CONTENT" ]; then
            echo "âš ï¸ OpenAI API call failed or returned empty response"
            echo "summary=AI analysis unavailable" >> $GITHUB_OUTPUT
            echo "labels=enhancement" >> $GITHUB_OUTPUT
            echo "changelog=- Updated repository" >> $GITHUB_OUTPUT
          else
            # Parse JSON response
            SUMMARY=$(echo "$CONTENT" | jq -r '.summary // "AI-generated summary unavailable"')
            LABELS=$(echo "$CONTENT" | jq -r '.labels[]? // "enhancement"' | tr '\n' ',' | sed 's/,$//')
            CHANGELOG=$(echo "$CONTENT" | jq -r '.changelog // "- Updated repository"')

            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
            echo "labels=$LABELS" >> $GITHUB_OUTPUT
            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          fi

      - name: Add PR Comment with Summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.openai-summary.outputs.summary }}`;
            const labels = `${{ steps.openai-summary.outputs.labels }}`.split(',').filter(l => l);
            const changelog = `${{ steps.openai-summary.outputs.changelog }}`;

            const comment = `## ðŸ¤– AI-Powered PR Assistant

            ### Summary
            ${summary}

            ### Suggested Labels
            ${labels.map(l => `\`${l}\``).join(', ')}

            ### Changelog Entry
            \`\`\`
            ${changelog}
            \`\`\`

            ---
            *Generated by AI-Powered PR Assistant*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Apply Suggested Labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = `${{ steps.openai-summary.outputs.labels }}`.split(',').filter(l => l);

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

      - name: Log Results
        run: |
          echo "âœ… PR Assistant completed successfully"
          echo "Summary: ${{ steps.openai-summary.outputs.summary }}"
          echo "Labels: ${{ steps.openai-summary.outputs.labels }}"
          echo "Changelog: ${{ steps.openai-summary.outputs.changelog }}"
